<html>

<head>
  <script src="./ffmpeg.min.js"></script>
  <style>
    html,
    body {
      margin: 0;
      width: 100%;
      height: 100%
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
  </style>
</head>

<body>
  <h3>Upload a video to transcode to mp4 (x264) and play!</h3>
  <video id="output-video" controls></video><br />
  <input type="file" id="uploader">
  <button onClick="cancel()">Cancel</button>
  <p id="message"></p>



  <br><br><br>
  <h2>實驗從這裡開始</h2>
  <video id="merged-video" controls></video><br />
  <label for="m4s">m4s</label>
  <input type="file" id="m4s" name="m4s" accept=".m4s">
  <label for="m4a">m4a</label>
  <input type="file" id="m4a" name="m4a" accept=".m4a">
  <button id="merge">合併</button>

  <p id="message2"></p>

  <script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    let ffmpeg = null;

    const transcode = async ({ target: { files } }) => {
      if (ffmpeg === null) {
        ffmpeg = createFFmpeg({ log: true });
      }
      const message = document.getElementById('message2');
      const audioFile = document.getElementById('m4a').files[0];
      const videoFile = document.getElementById('m4s').files[0];
      const outputFile = { name: 'output.mp4' };

      message.innerHTML = 'Loading ffmpeg-core.js';
      if (!ffmpeg.isLoaded()) {
        await ffmpeg.load();
      }

      ffmpeg.FS('writeFile', audioFile.name, await fetchFile(audioFile));
      ffmpeg.FS('writeFile', videoFile.name, await fetchFile(videoFile));


      message.innerHTML = '讀取files完畢';
      await ffmpeg.run('-i', audioFile.name, '-i', videoFile.name, '-c', 'copy', outputFile.name);
      message.innerHTML = 'Complete transcoding';
      const data = ffmpeg.FS('readFile', outputFile.name);

      const video = document.getElementById('merged-video');
      video.src = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
    }
    const elm = document.getElementById('merge');
    elm.addEventListener('click', transcode);

    const cancel = () => {
      try {
        ffmpeg.exit();
      } catch (e) { }
      ffmpeg = null;
    }
  </script>

  <!--<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    let ffmpeg = null;

    const transcode = async ({ target: { files } }) => {
      if (ffmpeg === null) {
        ffmpeg = createFFmpeg({ log: true });
      }
      const message = document.getElementById('message');
      const { name } = files[0];
      message.innerHTML = 'Loading ffmpeg-core.js';
      if (!ffmpeg.isLoaded()) {
        await ffmpeg.load();
      }
      ffmpeg.FS('writeFile', name, await fetchFile(files[0]));
      message.innerHTML = 'Start transcoding';
      await ffmpeg.run('-i', name, 'output.mp4');
      message.innerHTML = 'Complete transcoding';
      const data = ffmpeg.FS('readFile', 'output.mp4');

      const video = document.getElementById('output-video');
      video.src = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
    }
    const elm = document.getElementById('uploader');
    elm.addEventListener('change', transcode);

    const cancel = () => {
      try {
        ffmpeg.exit();
      } catch (e) { }
      ffmpeg = null;
    }
  </script>-->
</body>

</html>