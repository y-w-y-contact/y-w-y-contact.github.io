<!DOCTYPE html>
<html>
<head>
  <title>Merge Audio and Video</title>
</head>
<body>
  <h1>Merge Audio and Video</h1>
  
  <input type="file" id="audioFileInput" accept="audio/mp4, audio/m4a">
  <input type="file" id="videoFileInput" accept="video/mp4, video/m4s">

  <div>
    <video id="mergedVideo" controls></video>
  </div>

  <script>
    const videoElement = document.getElementById('mergedVideo');
    const mediaSource = new MediaSource();
    let audioLoaded = false;
    let videoLoaded = false;

    videoElement.src = URL.createObjectURL(mediaSource);

    mediaSource.addEventListener('sourceopen', handleSourceOpen);

    function handleSourceOpen() {
      const sourceBuffer = mediaSource.addSourceBuffer('video/mp4; codecs="avc1.42E01E"');

      sourceBuffer.addEventListener('updateend', handleUpdateEnd);
    }

    function handleUpdateEnd() {
      if (audioLoaded && videoLoaded) {
        const sourceBuffer = mediaSource.sourceBuffers[0];
        if (!sourceBuffer.updating && mediaSource.readyState === 'open') {
          mediaSource.endOfStream();
        }
      }
    }

    function mergeAudioAndVideo() {
      const audioFile = document.getElementById('audioFileInput').files[0];
      const videoFile = document.getElementById('videoFileInput').files[0];

      if (!audioFile || !videoFile) {
        alert('Please select an audio file and a video file.');
        return;
      }

      const sourceBuffer = mediaSource.sourceBuffers[0];
      if (sourceBuffer.updating) {
        alert('Please wait for the previous merge operation to complete.');
        return;
      }

      const audioReader = new FileReader();
      audioReader.onload = function () {
        audioLoaded = true;
        if (videoLoaded) {
          sourceBuffer.appendBuffer(this.result);
        }
      };
      audioReader.readAsArrayBuffer(audioFile);

      const videoReader = new FileReader();
      videoReader.onload = function () {
        videoLoaded = true;
        if (audioLoaded) {
          sourceBuffer.appendBuffer(this.result);
        }
      };
      videoReader.readAsArrayBuffer(videoFile);
    }

    document.getElementById('audioFileInput').addEventListener('change', mergeAudioAndVideo);
    document.getElementById('videoFileInput').addEventListener('change', mergeAudioAndVideo);
  </script>
</body>
</html>
